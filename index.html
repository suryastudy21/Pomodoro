<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sequenced Interval Timer</title>
  <style>
    :root {
      --bg: #111;
      --fg: #ffffff;
      --panel: #1f1f1f;
      --border: #333;
      --pad-scale: 0rem;
      --gear-offset: 0rem;
    }

    html, body {
      -webkit-user-select: none;
      -ms-user-select: none;
      user-select: none;
      width: 100%;
      height: 100%;
      margin: 0;
    }

    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background-color: var(--bg);
      color: var(--fg);
      overflow: hidden;
    }

    .timer {
      position: relative;
      width: 100%;
      height: 100%;
      padding: var(--pad-scale);
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
    }

    .time-wrap {
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .time {
      font-size: 200px;
      line-height: 1;
      font-variant-numeric: tabular-nums;
      cursor: pointer;
      white-space: nowrap;
      transform-origin: center center;
    }

    .gear {
      position: absolute;
      top: var(--gear-offset);
      right: var(--gear-offset);
      background: none;
      border: none;
      color: inherit;
      font-size: 3.6rem;
      cursor: pointer;
      opacity: 0.7;
    }

    .gear:hover { opacity: 1; }

    .sequence {
      margin-top: 1rem;
      font-size: 0.9rem;
      opacity: 0.85;
      white-space: normal;
      text-align: center;
    }

    .sequence button {
      background: none;
      border: none;
      color: inherit;
      font: inherit;
      padding: 0;
      cursor: pointer;
    }

    .sequence button.active {
      font-weight: 600;
      text-decoration: underline;
    }

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(6px);
      display: none;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: var(--panel);
      padding: 1.6rem 1.6rem 1.8rem;
      border: none;
      border-radius: 16px;
      width: 540px;
      max-height: 80vh;
      overflow-y: auto;
      scrollbar-width: none; /* Firefox */
      -ms-overflow-style: none; /* IE/Edge */
      box-shadow: 0 20px 60px rgba(0,0,0,0.6);
    }

    .modal-content::-webkit-scrollbar {
      width: 0;
      height: 0;
      background: transparent;
    }

    .close-x {
      position: sticky;
      top: 0.8rem;
      margin-left: auto;
      background: rgba(255,255,255,0.18);
      border: 1px solid rgba(255,255,255,0.25);
      color: #ffffff;
      font-size: 1.2rem;
      font-weight: 600;
      cursor: pointer;
      width: 2.75rem;
      height: 2.75rem;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      border-radius: 10px;
      z-index: 3;
      transition: background 0.15s ease, transform 0.1s ease, box-shadow 0.15s ease;
    }

    .close-x:hover {
      background: rgba(255,255,255,0.28);
      box-shadow: 0 4px 12px rgba(0,0,0,0.35);
    }

    .close-x:active {
      transform: scale(0.95);
    }

    .close-x:focus-visible {
      outline: none;
      box-shadow: 0 0 0 2px rgba(255,255,255,0.9), 0 0 0 4px rgba(0,0,0,0.6);
    }

    .section {
      margin-bottom: 1.6rem;
      padding: 1rem 1rem 1.2rem;
      border-radius: 12px;
      background: rgba(255,255,255,0.03);
    }

    .section h3 {
      margin: 0 0 0.8rem;
      font-size: 0.85rem;
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      opacity: 0.75;
    }

    .setting {
      margin: 0.9rem 0;
      font-size: 0.95rem;
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }

    .hint {
      font-size: 0.75rem;
      opacity: 0.6;
      margin-top: 0.1rem;
    }

    .toggle-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      cursor: pointer;
    }

    .toggle-row input { display: none; }

    .toggle {
      width: 42px;
      height: 24px;
      background: rgba(255,255,255,0.2);
      border-radius: 999px;
      position: relative;
      transition: background 0.2s ease;
    }

    .toggle::after {
      content: "";
      position: absolute;
      top: 3px;
      left: 3px;
      width: 18px;
      height: 18px;
      background: #fff;
      border-radius: 50%;
      transition: transform 0.2s ease;
    }

    .toggle-row input:checked + .toggle { background: #4ade80; }
    .toggle-row input:checked + .toggle::after { transform: translateX(18px); }

    .range-labels {
      display: flex;
      justify-content: space-between;
      font-size: 0.7rem;
      opacity: 0.6;
      margin: 0.2rem 0;
    }

    .setting input[type="range"] {
      width: 100%;
      -webkit-appearance: none;
      height: 6px;
      border-radius: 999px;
      background: rgba(255,255,255,0.15);
      outline: none;
    }

    .setting input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #fff;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.4);
    }

    .block-list {
      margin-top: 0.6rem;
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
    }

    .block-row {
      display: grid;
      grid-template-columns: auto 1.8fr 0.8fr 0.8fr auto;
      gap: 0.6rem;
      padding: 0.6rem 0.6rem;
      border-radius: 10px;
      align-items: center;
      background: rgba(255,255,255,0.04);
      cursor: default;
    }

    .block-row:hover { background: rgba(255,255,255,0.07); }

    .block-row input {
      padding: 0.4rem 0.45rem;
      border-radius: 6px;
      border: none;
      background: rgba(0,0,0,0.35);
      color: inherit;
      font-size: 0.85rem;
    }

    .block-row input[type="number"] { width: 3.2rem; text-align: center; }

    .block-row button { cursor: pointer; }

    .block-row button.up,
    .block-row button.down {
      width: 22px;
      height: 22px;
      padding: 0;
      background: none;
      border: none;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: rgba(255,255,255,0.55);
    }

    .block-row button.up:hover,
    .block-row button.down:hover { color: #fff; background: rgba(255,255,255,0.12); }

    .block-row button:last-child { opacity: 1; background: none; border: none; color: #ffffff; font-weight: 600; }
    .block-row button:last-child:hover { opacity: 1; background: rgba(255,255,255,0.12); }

    button.add {
      margin-top: 0.6rem;
      background: rgba(255,255,255,0.06);
      border: none;
      color: inherit;
      padding: 0.5rem 0.7rem;
      border-radius: 8px;
      opacity: 0.85;
    }

    button.add:hover { opacity: 1; }
  </style>
</head>
<body>
  <div class="timer">
    <button class="gear" id="edit" title="Settings">⚙</button>
    <button class="gear" id="fullscreen" title="Toggle Fullscreen" style="right: calc(var(--gear-offset) + 3.8rem);">⛶</button>

    <div class="time-wrap" id="timeWrap">
      <div class="time" id="time"></div>
    </div>

    <div class="sequence" id="sequence"></div>
  </div>

  <div class="modal" id="editor">
    <div class="modal-content">
      <button class="close-x" id="closeEditorX" aria-label="Close">✕</button>

      <div class="section">
        <h3>Behavior</h3>
        <div class="setting">
          <label class="toggle-row">
            <span>Enable pause</span>
            <input type="checkbox" id="enablePause" />
            <span class="toggle"></span>
          </label>
          <div class="hint">Prevents manual mode switching while the timer is running</div>
        </div>

        <div class="setting">
          <label>Display size</label>
          <div class="range-labels"><span>Small</span><span>Large</span></div>
          <input type="range" id="sizeSlider" min="0" max="100" />
        </div>
      </div>

      <div class="section">
        <h3>Sequence</h3>
        <div id="blockList" class="block-list"></div>
        <button id="addBlock" class="add">＋ Add block</button>
      </div>
    </div>
  </div>

  <audio id="bellSound" preload="auto">
    <source src="bell-98033.mp3" type="audio/mpeg" />
  </audio>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const STORAGE_KEY = "sequenced_timer_state_v1";

      let blocks = [
        { label: "Long Break", duration: 20 * 60, color: "#064e3b" },
        { label: "Focus", duration: 35 * 60, color: "#000000" },
        { label: "Break", duration: 6 * 60, color: "#fbbf24" }
      ];

      let enablePause = false;
      let sizeLevel = 100;
      let userScale = 1;

      function saveState() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify({ blocks, enablePause, sizeLevel }));
      }

      function loadState() {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        try {
          const s = JSON.parse(raw);
          if (Array.isArray(s.blocks)) blocks = s.blocks;
          if (typeof s.enablePause === "boolean") enablePause = s.enablePause;
          if (typeof s.sizeLevel === "number") sizeLevel = s.sizeLevel;
        } catch {}
      }

      loadState();

      let currentIndex = 0;
      let remainingSeconds = blocks[0].duration;
      let intervalId = null;
      let running = false;

      const timeEl = document.getElementById("time");
      const timeWrap = document.getElementById("timeWrap");
      const editBtn = document.getElementById("edit");
      const fullscreenBtn = document.getElementById("fullscreen");
      const sequenceEl = document.getElementById("sequence");
      const editor = document.getElementById("editor");
      const blockList = document.getElementById("blockList");
      const addBlockBtn = document.getElementById("addBlock");
      const closeEditorBtn = document.getElementById("closeEditorX");
      const enablePauseCheckbox = document.getElementById("enablePause");
      const sizeSlider = document.getElementById("sizeSlider");
      const bellSound = document.getElementById("bellSound");

      function applySize() {
        const pad = (1 - sizeLevel / 100) * 3;
        document.documentElement.style.setProperty("--pad-scale", `${pad}rem`);
        document.documentElement.style.setProperty("--gear-offset", `${pad}rem`);

        const container = document.querySelector(".timer");
        timeEl.style.transform = "scale(1)";
        const baseWidth = timeEl.scrollWidth || 1;
        const baseHeight = timeEl.scrollHeight || 1;

        const fitScale = Math.min(
          container.clientWidth / baseWidth,
          (container.clientHeight * 0.75) / baseHeight
        );

        const finalScale = fitScale * userScale;
        timeEl.style.transform = `scale(${finalScale})`;
        timeWrap.style.height = `${baseHeight * finalScale}px`;
      }

      function formatTime(sec) {
        return `${String(Math.floor(sec / 60)).padStart(2, "0")}:${String(sec % 60).padStart(2, "0")}`;
      }

      function renderSequence() {
        editBtn.style.display = running ? "none" : "block";
        sequenceEl.innerHTML = blocks.map((b, i) => `<button class="${i === currentIndex ? "active" : ""}">${b.label}</button>`).join(" → ");
        [...sequenceEl.children].forEach((btn, i) => {
          btn.onclick = () => {
            if (enablePause) return;
            running = false;
            clearInterval(intervalId);
            currentIndex = i;
            loadBlock(i);
          };
        });
      }

      function loadBlock(i) {
        const b = blocks[i];
        if (!b) return;
        document.body.style.backgroundColor = b.color;
        remainingSeconds = b.duration;
        timeEl.textContent = formatTime(remainingSeconds);
        applySize();
        renderSequence();
      }

      timeEl.onclick = () => {
        if (running) {
          if (enablePause) return;
          clearInterval(intervalId);
          running = false;
        } else {
          // immediate feedback: tick once instantly
          remainingSeconds = Math.max(remainingSeconds - 1, 0);
          timeEl.textContent = formatTime(remainingSeconds);

          intervalId = setInterval(() => {
            remainingSeconds--;
            if (remainingSeconds < 0) remainingSeconds = 0;
            timeEl.textContent = formatTime(remainingSeconds);
          }, 1000);
          running = true;
        }
        renderSequence();
      };

      editBtn.onclick = () => {
        enablePauseCheckbox.checked = enablePause;
        sizeSlider.value = sizeLevel;
        renderEditor();
        editor.style.display = "flex";
      };

      closeEditorBtn.onclick = () => {
        enablePause = enablePauseCheckbox.checked;
        blocks = readEditor();
        saveState();
        editor.style.display = "none";
        running = false;
        clearInterval(intervalId);
        loadBlock(0);
      };

      sizeSlider.oninput = e => {
        sizeLevel = +e.target.value;
        userScale = 0.25 + (sizeLevel / 100) * 0.75;
        applySize();
        saveState();
      };

      addBlockBtn.onclick = () => {
        const rows = [...blockList.children];
        if (rows.length === 0) {
          blockList.appendChild(
            blockRow({ label: "New Block", duration: 300, color: "#444" })
          );
          return;
        }

        const last = rows[rows.length - 1];
        const [l, m, c] = last.querySelectorAll("input");

        blockList.appendChild(
          blockRow({
            label: l.value,
            duration: +m.value * 60,
            color: c.value
          })
        );

        syncBlockProperties();
      };

      
      function syncBlockProperties() {
        const seen = new Map();

        [...blockList.children].forEach(row => {
          const inputs = row.querySelectorAll("input");
          const labelInput = inputs[0];
          const durationInput = inputs[1];
          const colorInput = inputs[2];

          const name = labelInput.value.trim();
          if (!name) return;

          if (!seen.has(name)) {
            seen.set(name, {
              duration: durationInput.value,
              color: colorInput.value
            });
          } else {
            const canon = seen.get(name);
            if (durationInput.value !== canon.duration)
              durationInput.value = canon.duration;
            if (colorInput.value !== canon.color)
              colorInput.value = canon.color;
          }
        });
      }

function renderEditor() {
        blockList.innerHTML = "";
        blocks.forEach(b => blockList.appendChild(blockRow(b)));
      }

      function blockRow(b) {
        const r = document.createElement("div");
        r.className = "block-row";
        r.innerHTML = `
          <div class="move-controls">
            <button class="up" aria-label="Move up">▲</button>
            <button class="down" aria-label="Move down">▼</button>
          </div>
          <input value="${b.label}">
          <input type="number" value="${b.duration / 60}" min="0" step="1">
          <input type="color" value="${b.color}">
          <button class="delete" aria-label="Delete block">✕</button>`;

        const upBtn = r.querySelector(".up");
        const downBtn = r.querySelector(".down");
        const delBtn = r.querySelector(".delete");

        upBtn.onclick = e => {
          e.preventDefault();
          const prev = r.previousElementSibling;
          if (prev) blockList.insertBefore(r, prev);
        };

        downBtn.onclick = e => {
          e.preventDefault();
          const next = r.nextElementSibling;
          if (next) blockList.insertBefore(next, r);
        };

        delBtn.onclick = e => {
          e.preventDefault();
          r.remove();
        };

        const inputs = r.querySelectorAll("input");
        inputs.forEach(inp => {
          inp.addEventListener("input", () => {
            syncBlockProperties();
          });
        });

        return r;
      }

      function readEditor() {
        return [...blockList.children].map(r => {
          const [l, m, c] = r.querySelectorAll("input");
          return { label: l.value.trim() || "Untitled", duration: +m.value * 60, color: c.value };
        });
      }

      // basic sanity checks
      console.assert(typeof applySize === "function", "applySize exists");
      console.assert(typeof blockRow === "function", "blockRow exists");

      applySize();
      loadBlock(0);
    });
  </script>
</body>
</html>
