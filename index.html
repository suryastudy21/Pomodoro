<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sequenced Interval Timer</title>
  <style>
    :root {
      --bg: #111;
      --fg: #ffffff;
      --panel: #1f1f1f;
      --border: #333;
      --pad-scale: 0rem;
      --gear-offset: 0rem;
    }

    html, body {
      -webkit-user-select: none;
      -ms-user-select: none;
      user-select: none;
      width: 100%;
      height: 100%;
      margin: 0;
    }

    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background-color: var(--bg);
      color: var(--fg);
      overflow: hidden;
    }

    .timer {
      position: relative;
      width: 100%;
      height: 100%;
      padding: var(--pad-scale);
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
    }

    .time-wrap {
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .time {
      font-size: 200px;
      line-height: 1;
      font-variant-numeric: tabular-nums;
      cursor: pointer;
      white-space: nowrap;
      transform-origin: center center;
    }

    .gear {
      position: absolute;
      top: var(--gear-offset);
      right: var(--gear-offset);
      background: none;
      border: none;
      color: inherit;
      font-size: 3.6rem;
      cursor: pointer;
      opacity: 0.7;
    }

    .gear:hover { opacity: 1; }

    .sequence {
      margin-top: 1rem;
      font-size: 0.9rem;
      opacity: 0.85;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 0.4rem;
    }

    .sequence button {
      background: none;
      border: none;
      color: inherit;
      font: inherit;
      padding: 0;
      cursor: pointer;
    }

    .sequence button.active {
      font-weight: 600;
      text-decoration: underline;
    }

    .sequence button.disabled {
      opacity: 0.4;
      cursor: default;
    }

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      display: none;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: var(--panel);
      padding: 1.2rem;
      border: 1px solid var(--border);
      width: 520px;
      max-height: 80vh;
      overflow-y: auto;
    }

    .setting {
      margin: 0.8rem 0;
      font-size: 0.9rem;
    }

    .setting input[type="range"] { width: 100%; }

    .block-row {
      cursor: grab;
      display: grid;
      grid-template-columns: 1.5fr 1fr 1fr auto;
      gap: 0.4rem;
      margin-bottom: 0.4rem;
    }

    .block-row input { padding: 0.3rem; }
    .block-row button { cursor: pointer; }

    .modal-actions {
      margin-top: 0.8rem;
      text-align: right;
    }

    ::selection { background: transparent; }
    ::-moz-selection { background: transparent; }
  </style>
</head>
<body>
  <div class="timer">
    <button class="gear" id="edit" title="Settings">⚙</button>
    <button class="gear" id="fullscreen" title="Toggle Fullscreen" style="right: calc(var(--gear-offset) + 3.8rem);">⛶</button>

    <div class="time-wrap" id="timeWrap">
      <div class="time" id="time"></div>
    </div>

    <div class="sequence" id="sequence"></div>
  </div>

  <div class="modal" id="editor">
    <div class="modal-content">
      <h3>Sequence & Settings</h3>

      <div class="setting">
        <label><input type="checkbox" id="enablePause" /> Enable pause</label>
      </div>

      <div class="setting">
        <label>Size
          <input type="range" id="sizeSlider" min="0" max="100" />
        </label>
      </div>

      <hr />

      <div id="blockList"></div>
      <button id="addBlock">Add Block</button>

      <div class="modal-actions">
        <button id="closeEditor">Apply & Close</button>
      </div>
    </div>
  </div>

  <audio id="bellSound" preload="auto">
    <source src="bell-98033.mp3" type="audio/mpeg" />
  </audio>

  <script>
    const STORAGE_KEY = "sequenced_timer_state_v1";

    let blocks = [
      { label: "Long Break", duration: 20 * 60, color: "#064e3b" },
      { label: "Focus", duration: 35 * 60, color: "#000000" },
      { label: "Break", duration: 6 * 60, color: "#fbbf24" },
      { label: "Focus", duration: 35 * 60, color: "#000000" },
      { label: "Break", duration: 6 * 60, color: "#fbbf24" },
      { label: "Focus", duration: 35 * 60, color: "#000000" },
      { label: "Break", duration: 6 * 60, color: "#fbbf24" },
      { label: "Focus", duration: 35 * 60, color: "#000000" },
      { label: "Break", duration: 6 * 60, color: "#fbbf24" },
      { label: "Focus", duration: 35 * 60, color: "#000000" }
    ];

    let enablePause = false;
    let sizeLevel = 100;

    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify({ blocks, enablePause, sizeLevel }));
    }

    function loadState() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      try {
        const s = JSON.parse(raw);
        if (Array.isArray(s.blocks)) blocks = s.blocks;
        if (typeof s.enablePause === "boolean") enablePause = s.enablePause;
        if (typeof s.sizeLevel === "number") sizeLevel = s.sizeLevel;
      } catch {}
    }

    loadState();

    let currentIndex = 0;
    let remainingSeconds = blocks[0].duration;
    let intervalId = null;
    let running = false;

    const timeEl = document.getElementById("time");
    const timeWrap = document.getElementById("timeWrap");
    const editBtn = document.getElementById("edit");
    const fullscreenBtn = document.getElementById("fullscreen");
    const sequenceEl = document.getElementById("sequence");
    const editor = document.getElementById("editor");
    const blockList = document.getElementById("blockList");
    const addBlockBtn = document.getElementById("addBlock");
    const closeEditorBtn = document.getElementById("closeEditor");
    const enablePauseCheckbox = document.getElementById("enablePause");
    const sizeSlider = document.getElementById("sizeSlider");
    const bellSound = document.getElementById("bellSound");

    function playBell() {
      bellSound.currentTime = 0;
      bellSound.play().catch(() => {});
    }

    function applySize() {
      const pad = (1 - sizeLevel / 100) * 3;
      document.documentElement.style.setProperty("--pad-scale", `${pad}rem`);
      document.documentElement.style.setProperty("--gear-offset", `${pad}rem`);

      const container = document.querySelector(".timer");
      const baseWidth = timeEl.scrollWidth;
      const baseHeight = timeEl.scrollHeight;
      const scale = Math.min(container.clientWidth / baseWidth, (container.clientHeight * 0.75) / baseHeight);
      timeEl.style.transform = `scale(${scale})`;
      timeWrap.style.height = `${baseHeight * scale}px`;
    }

    function formatTime(sec) {
      return `${String(Math.floor(sec / 60)).padStart(2, "0")}:${String(sec % 60).padStart(2, "0")}`;
    }

    function renderSequence() {
      editBtn.style.display = running ? "none" : "block";
      sequenceEl.innerHTML = blocks.map((b, i) => `<button class="${i === currentIndex ? "active" : ""}">${b.label}</button>`).join(" → ");
      [...sequenceEl.children].forEach((btn, i) => btn.onclick = () => { running = false; clearInterval(intervalId); currentIndex = i; loadBlock(i); });
    }

    function loadBlock(i) {
      const b = blocks[i];
      if (!b) return;
      document.body.style.backgroundColor = b.color;
      remainingSeconds = b.duration;
      timeEl.textContent = formatTime(remainingSeconds);
      applySize();
      renderSequence();
    }

    function advanceBlock() {
      playBell();
      if (currentIndex < blocks.length - 1) loadBlock(++currentIndex);
      else { clearInterval(intervalId); running = false; renderSequence(); }
    }

    function tick() {
      remainingSeconds > 0 ? (remainingSeconds--, timeEl.textContent = formatTime(remainingSeconds), applySize()) : advanceBlock();
    }

    timeEl.onclick = () => {
      running ? (enablePause || (clearInterval(intervalId), running = false)) : (tick(), intervalId = setInterval(tick, 1000), running = true);
      renderSequence();
    };

    fullscreenBtn.onclick = () => document.fullscreenElement ? document.exitFullscreen() : document.documentElement.requestFullscreen();
    document.addEventListener("fullscreenchange", () => fullscreenBtn.style.display = document.fullscreenElement ? "none" : "block");

    editBtn.onclick = () => { enablePauseCheckbox.checked = enablePause; sizeSlider.value = sizeLevel; renderEditor(); editor.style.display = "flex"; };

    closeEditorBtn.onclick = () => {
      enablePause = enablePauseCheckbox.checked;
      blocks = readEditor();
      saveState();
      editor.style.display = "none";
      running = false;
      clearInterval(intervalId);
      loadBlock(0);
    };

    sizeSlider.oninput = e => { sizeLevel = +e.target.value; applySize(); saveState(); };
    addBlockBtn.onclick = () => {
      const lastRow = blockList.lastElementChild;
      if (lastRow) {
        const [l, m, c] = lastRow.querySelectorAll("input");
        blockList.appendChild(blockRow({
          label: l.value || "New Block",
          duration: Number(m.value) * 60,
          color: c.value
        }));
      } else {
        blockList.appendChild(blockRow({ label: "New Block", duration: 300, color: "#444" }));
      }
    };

    function renderEditor() { blockList.innerHTML = ""; blocks.forEach(b => blockList.appendChild(blockRow(b))); }

    function blockRow(b) {
      const r = document.createElement("div");
      r.className = "block-row";
      r.draggable = true;
      r.innerHTML = `<input value="${b.label}"><input type="number" value="${b.duration / 60}"><input type="color" value="${b.color}"><button>✕</button>`;

      const [labelInput, minutesInput, colorInput] = r.querySelectorAll("input");

      function findPreviousSameLabelRow() {
        const rows = [...blockList.children];
        const idx = rows.indexOf(r);
        const label = labelInput.value.trim() || "Untitled";
        for (let i = idx - 1; i >= 0; i--) {
          const [l] = rows[i].querySelectorAll("input");
          if ((l.value.trim() || "Untitled") === label) return rows[i];
        }
        return null;
      }

      labelInput.addEventListener("input", () => {
        const prev = findPreviousSameLabelRow();
        if (!prev) return;
        const [, pm, pc] = prev.querySelectorAll("input");
        minutesInput.value = pm.value;
        colorInput.value = pc.value;
      });

            r.addEventListener("dragstart", e => {
        draggedRow = r;
        r.style.opacity = "0.5";
        e.dataTransfer.effectAllowed = "move";
        e.dataTransfer.setData("text/plain", "");
      });

      r.addEventListener("dragend", () => {
        r.style.opacity = "";
        draggedRow = null;
      });

      r.addEventListener("dragover", e => e.preventDefault());

      r.addEventListener("drop", e => {
        e.preventDefault();
        if (!draggedRow || draggedRow === r) return;
        const rows = [...blockList.children];
        const from = rows.indexOf(draggedRow);
        const to = rows.indexOf(r);
        blockList.insertBefore(draggedRow, from < to ? r.nextSibling : r);
      });

      r.querySelector("button").onclick = () => r.remove();
      return r;
    }

    function readEditor() {
      const rows = [...blockList.children];
      const canon = {};
      rows.forEach(r => {
        const [l, m, c] = r.querySelectorAll("input");
        const label = l.value.trim() || "Untitled";
        if (!canon[label]) canon[label] = { duration: +m.value * 60, color: c.value };
      });
      return rows.map(r => {
        const l = r.querySelector("input").value.trim() || "Untitled";
        return { label: l, ...canon[l] };
      });
    }

    applySize();
    loadBlock(0);
  </script>
</body>
</html>
